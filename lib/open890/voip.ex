defmodule Open890.VOIP do
  @payload_type 96
  @timestamp 0
  @ssrc 0x38393000
  @sample_payload "1f00240022001a001b0024002700300032002a001e0027002f002f00270026002d0029002b0026002b00290027002e002e001e0018002c0028002600290021002a002b0032002c0025002f002e0029002b002f0032002e002b00300039003500360036002e00220029002800210022001c002200240028002500170019001a001c001f0027001e001a00250020002b001a001b001c001700160014001d001d0026002100250013000c00090004000600060010000800050008000600ffff08000900100016001b0018000c000900130018001f001b001c00200024002300260020001b0017001f0025001e0020001c000f00090012001d001a001b001e0019001e0024001d001b0023001c001c00210021002600270025002d002200220028002500230025002d00280024002a00310029002e00220023002c0025002a003000330032002e003900380037003800340036004000490043004a0048003f003a0037003a00360031003e0044004400460044004f00520059005a0059005a005a006200670067006b00690069006400610064005b005c00610058005200550057004c004e006000530055005e00640065005b005f005f006000610062006a00670069006800680066006b0069005e0063005f0062006200660063005d005c005d0063006000650064006d0069006d006e005e005a005900620061005d00660064005c005c0063006a0064007400690066006d00680063006a006d006a006e007000710069007000750073007100770078007a008200770073007a007500700075006b0069006b006f0070006d006e00710069005a005c005e005a005900590050004c005c005e0058005b00580054005e005d00580057005b005a0057005f005900"


  def make_packet(seq_num, payload) do
    <<
      2::size(2),
      0::size(1),
      0::size(1),
      0::size(4),
      @payload_type::size(8),
      seq_num::size(16),
      @timestamp::size(32),
      @ssrc::size(32),
      payload::binary
    >>
  end

  def payload_bytes(str) when is_binary(str) do
    str
    |> String.codepoints()
    |> Enum.chunk_every(2)
    |> Enum.map(&Enum.join/1)
    |> Enum.map(fn x ->
      {int, _} = Integer.parse(x, 16)
      int
     end)
    |> Enum.into(<<>>, fn int -> <<int::8>> end)
  end

  def sample_payload_bytes do
    sample_payload() |> payload_bytes()
  end

  def sample_payload, do: @sample_payload

end
